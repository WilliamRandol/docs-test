<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: grid;
            grid-template-columns: minmax(min-content, 1fr) 6fr;
            height: 100vh;
            width: 100vw;
        }

        aside {
            padding: .5rem;
            overflow-y: auto;
            text-wrap: nowrap;
            border-right: 1px solid rgba(128,128,128, .5);
        }

        aside menu {
            list-style: none;
            padding: 0;
            margin: 0;
            margin-left: 1rem;
        }

        main {
            padding: 1rem;
            overflow-y: auto;
        }
    </style>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.4.0/github-markdown.min.css"
        integrity="sha512-30lMQ13MJJk66BfdlnvVnKmP05V7Qt1g6sHyYigDgV8i9M2ENAsXk1U4dVvKUYB6pqb2bVhoxhZsYK08hQpS+g=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script>
        const treeUrl = 'https://api.github.com/repos/WilliamRandol/docs-test/git/trees/main?recursive=1';
        const fileRootUrl = 'https://raw.githubusercontent.com/WilliamRandol/docs-test/main/';

        window.addEventListener('load', () => {
            const tableOfContents = document.querySelector('aside');

            init();

            async function getAllFiles() {
                const response = await fetch(treeUrl);
                const data = await response.json();
                const files = data.tree.filter(file => file.type == 'blob' && file.path.endsWith('.md'));
                const folders = data.tree.filter(file => file.type == 'tree');
                const sortedFiles = files.filter(file => file.path.split('/').length == 1);
                for (const folder of folders) {
                    const folderFiles = files.filter(file => file.path.startsWith(folder.path));
                    sortedFiles.push({
                        path: folder.path,
                        files: folderFiles
                    })
                }
                return sortedFiles;
            }

            async function init() {
                const files = await getAllFiles();
                fillTableOfContent(files, tableOfContents);

                function fillTableOfContent(files, parent) {
                    const menu = document.createElement('menu');
                    console.log(files);
                    files.forEach(file => {
                        const menuItem = document.createElement('li');
                        if (file.files) {
                            const path = `${file.path}/`;
                            const name = file.path.split('/').at(-1);
                            if(file.files.some(f => f.path.replace(path, '') == 'README.md')) {
                                menuItem.innerHTML = `<a href="/#${encodeURIComponent(path)}">${name}</a>`;
                            } else {
                                menuItem.innerHTML = `<span>${name}</span>`;
                            }
                            fillTableOfContent(file.files, menuItem);
                        }
                        else {
                            const hash = encodeURIComponent(file.path.replace('.md', ''));
                            const name = file.path.split('/').at(-1).replace('.md', '');
                            if(file.path == 'README.md') {
                                menuItem.innerHTML = `<a href="#">Home</a>`;
                            }
                            else if(!file.path.endsWith('README.md')) {
                                menuItem.innerHTML += `<a href="/#${hash}">${name}</a>`;
                            }
                        }
                        menu.appendChild(menuItem);
                    })
                    parent.appendChild(menu);
                }
                
                window.dispatchEvent(new HashChangeEvent("hashchange"))
            }
        })

        window.addEventListener('hashchange', () => {
            let hash = decodeURIComponent(window.location.hash.replace('#', ''));
            console.log(hash);
            if(hash == '') {
                hash = 'README';
            }
            if(hash.endsWith('/')) {
                hash += 'README';
            }
            const hydratedUrl = `${fileRootUrl}${hash}.md`;
            fetch(hydratedUrl)
                .then(r => r.text())
                .then(async r => {
                    fetch('https://api.github.com/markdown', {
                        method: 'POST',
                        body: JSON.stringify({
                            text: r,
                            mode: 'gfm',
                            context: 'WilliamRandol/docs-test'
                        })
                    }).then(r => r.text()).then(r => document.querySelector('main').innerHTML = r);
                })
        })
    </script>

</html>

<body>
    <aside class="markdown-body">
    </aside>
    <main class="markdown-body"></main>
</body>

</html>
